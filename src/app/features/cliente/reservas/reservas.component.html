<div class="page-container">

  <div class="page-container">

    <!-- Encabezado -->
    <div class="page-header d-flex justify-content-between align-items-center">
      <div>
        <h1>Mis Reservas</h1>
        <p class="subtitle">Consulta y gestión de tus reservas</p>
      </div>

      <button class="btn btn-primary" (click)="abrirModalNuevo()">
        Nueva Reserva
      </button>
    </div>


    <div class="mt-3">
      <div *ngIf="error" class="alert alert-error">
        <strong>Error:</strong> {{ error }}
        <button class="alert-close" (click)="error = null">✕</button>
      </div>

      <div *ngIf="loading && reservas.length === 0" class="loading">
        Cargando tus reservas...
      </div>
    </div>


    <!-- Tabla -->
    <div class="table-container mt-4" *ngIf="!loading">

      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>Cancha</th>
            <th>Inicio</th>
            <th>Fin</th>
            <th>Estado</th>
            <th>Total</th>
            <th>Acciones</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let reserva of reservas">
            <td>{{ reserva.idReserva }}</td>
            <td>{{ getNombreCancha(reserva.canchaId) }}</td>
            <td>{{ reserva.inicio | date:'short' }}</td>
            <td>{{ reserva.fin | date:'short' }}</td>
            <td>
              <span class="badge" [ngClass]="getEstadoBadgeClass(reserva.estado)">
                {{ reserva.estado }}
              </span>
            </td>
            <td>$ {{ reserva.totalPagar | number:'1.2-2' }}</td>
            <td>
              <button class="btn-icon btn-edit" (click)="abrirModalEditar(reserva)">
                Editar
              </button>
              <button class="btn-icon btn-delete" (click)="eliminar(reserva.idReserva)">
                Eliminar
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <div *ngIf="reservas.length === 0" class="empty-state">
        No tienes reservas registradas.
      </div>

    </div>

  </div>
  <!-- Modal -->
  <div *ngIf="showModal" class="modal-overlay" (click)="cerrarModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">

      <div class="modal-header">
        <h2>{{ isEditMode ? 'Editar Reserva' : 'Nueva Reserva' }}</h2>
        <button class="modal-close" (click)="cerrarModal()">✕</button>
      </div>

      <form class="modal-body" (ngSubmit)="guardar()">

        <!-- Información General -->
        <div class="card mb-3">
          <h4 class="section-title">Información General</h4>

          <div class="form-group">
            <label>Cancha *</label>
            <select [(ngModel)]="form.canchaId" name="canchaId" (change)="onCanchaChange()">
              <option value="0">Seleccione una cancha</option>
              <option *ngFor="let c of canchas" [value]="c.idCancha">
                {{ c.nombre }}
              </option>
            </select>

            <div *ngIf="precioPorHora !== undefined" class="text-muted mt-1">
              <strong>{{ precioPorHora | currency:'COP' }}</strong>
            </div>

          </div>
        </div>

        <input type="hidden" [(ngModel)]="form.tarifaId" name="tarifaId">

        <!-- Horario -->
        <div class="card mb-3">
          <h4 class="section-title">Horario de Reserva</h4>

          <div class="form-row">
            <div class="form-group">
              <label>Inicio *</label>
              <input type="datetime-local" [(ngModel)]="form.inicio" name="inicio" required (input)="onHorarioChange()"
                (change)="onHorarioChange()">
            </div>

            <div class="form-group">
              <label>Fin *</label>
              <input type="datetime-local" [(ngModel)]="form.fin" name="fin" required (input)="onHorarioChange()"
                (change)="onHorarioChange()">
            </div>
          </div>
        </div>

        <!-- Opciones -->
        <div class="form-group checkbox mb-3">
          <label>
            <input type="checkbox" [(ngModel)]="form.incluirEntrenador" name="incluirEntrenador">
            Incluir entrenador en la reserva
          </label>
        </div>

        <!-- Estado y Pago -->
        <div class="card mb-3">
          <h4 class="section-title">Estado y Pago</h4>

          <div class="form-row">
            <div class="form-group">
              <label>Estado</label>
              <input class="form-control" value="Pendiente" readonly>
            </div>

            <div class="form-group">
              <label>Total a pagar</label>
              <input type="number" class="form-control bg-light fw-bold" [(ngModel)]="form.totalPagar" name="totalPagar"
                readonly>
            </div>
            <div class="text-muted mt-1" *ngIf="form.totalPagar > 0">
              Total calculado automáticamente
            </div>

          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="loading">
            {{ loading ? 'Guardando...' : 'Guardar Reserva' }}
          </button>
        </div>

      </form>
    </div>
  </div>